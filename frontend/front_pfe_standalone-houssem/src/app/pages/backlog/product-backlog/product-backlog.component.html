<div class="backlog-container">
  <!-- Header Section -->
  <div class="backlog-header">
    <div class="header-content">
      <div class="header-left">
        <button
          pButton
          type="button"
          icon="pi pi-arrow-left"
          class="p-button-text p-button-plain"
          (click)="goBack()"
          [pTooltip]="singleProjectMode ? 'Back to Project Details' : 'Back to Projects'">
        </button>
        <div class="header-title">
          <!-- Dynamic header based on mode -->
          @if (!singleProjectMode) {
            <h1>Product Backlogs</h1>
          }
          @if (singleProjectMode) {
            <h1>{{ currentProject?.nom || 'Project' }} - Product Backlog</h1>
          }
          @if (!singleProjectMode) {
            <p class="header-subtitle">Manage your product backlogs for all projects</p>
          }
          @if (singleProjectMode) {
            <p class="header-subtitle">Manage the product backlog and items for this project</p>
          }
        </div>
      </div>
      <div class="header-actions">
        <button
          pButton
          type="button"
          label="Export"
          icon="pi pi-download"
          class="p-button-outlined mr-2"
          (click)="exportBacklog()">
        </button>
        <button
          pButton
          type="button"
          label="Add Backlog"
          icon="pi pi-plus"
          class="p-button-primary"
          (click)="showAddDialog()">
        </button>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-number">{{ getTotalBacklogs() }}</div>
        <div class="stat-label">Total Backlogs</div>
      </div>
      <div class="stat-icon">
        <i class="pi pi-list"></i>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-number">{{ getActiveProjects() }}</div>
        <div class="stat-label">Active Projects</div>
      </div>
      <div class="stat-icon">
        <i class="pi pi-check-circle"></i>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-number">{{ getTotalItems() }}</div>
        <div class="stat-label">Total Items</div>
      </div>
      <div class="stat-icon">
        <i class="pi pi-bookmark"></i>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-number">{{ projects.length }}</div>
        <div class="stat-label">Projects</div>
      </div>
      <div class="stat-icon">
        <i class="pi pi-folder"></i>
      </div>
    </div>
  </div>

  <!-- Backlog Table -->
  <div class="backlog-table-container">
    <p-table
      [value]="productBacklogs"
      [(selection)]="selectedBacklogs"
      [paginator]="!singleProjectMode"
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [lazy]="!singleProjectMode"
      (onLazyLoad)="onPageChange($event)"
      [loading]="loading"
      [showCurrentPageReport]="!singleProjectMode"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="p-datatable-gridlines"
      responsiveLayout="scroll">

      <ng-template pTemplate="caption">
        <div class="table-header">
          <span class="table-title">Product Backlogs</span>
          <div class="table-actions">
            <button
              pButton
              type="button"
              icon="pi pi-trash"
              class="p-button-danger p-button-outlined"
              [disabled]="selectedBacklogs.length === 0"
              (click)="bulkDelete()"
              pTooltip="Delete Selected">
            </button>
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th pSortableColumn="projectName">Project <p-sortIcon field="projectName"></p-sortIcon></th>
          <th pSortableColumn="productOwnerName">Product Owner <p-sortIcon field="productOwnerName"></p-sortIcon></th>
          <th pSortableColumn="backlogItemsCount">Items Count <p-sortIcon field="backlogItemsCount"></p-sortIcon></th>
          <!-- Expanded actions column width -->
          <th style="width: 12rem">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-backlog>
        <tr>
          <td>
            <p-tableCheckbox [value]="backlog"></p-tableCheckbox>
          </td>
          <td>
            <div class="project-info">
              <strong>{{ backlog.projectName }}</strong>
              <div class="project-id">ID: {{ backlog.projectId }}</div>
            </div>
          </td>
          <td>{{ backlog.productOwnerName }}</td>
          <td>
            <span class="items-count">{{ backlog.backlogItemsCount }}</span>
          </td>
          <td>
            <div class="action-buttons">
              <!-- Added View Items button -->
              <button
                pButton
                type="button"
                icon="pi pi-eye"
                class="p-button-text p-button-sm"
                (click)="viewBacklogItems(backlog)"
                pTooltip="View Items">
              </button>
              <button
                pButton
                type="button"
                icon="pi pi-pencil"
                class="p-button-text p-button-sm"
                (click)="editBacklog(backlog)"
                pTooltip="Edit">
              </button>
              <button
                pButton
                type="button"
                icon="pi pi-trash"
                class="p-button-text p-button-sm p-button-danger"
                (click)="deleteBacklog(backlog)"
                pTooltip="Delete">
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center">
            <div class="empty-state">
              <i class="pi pi-inbox empty-icon"></i>
              <h3>No product backlogs found</h3>
              <!-- Dynamic empty message based on mode -->
              @if (!singleProjectMode) {
                <p>Start by creating your first product backlog</p>
              }
              @if (singleProjectMode) {
                <p>This project doesn't have a product backlog yet</p>
              }
              <button
                pButton
                type="button"
                [label]="singleProjectMode ? 'Create Backlog' : 'Create First Backlog'"
                icon="pi pi-plus"
                class="p-button-primary"
                (click)="showAddDialog()">
              </button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Added Backlog Items Section for single project mode -->
  @if (singleProjectMode && productBacklogs.length > 0) {
    <div class="backlog-items-section">
      <!-- Items Header -->
      <div class="items-header">
        <div class="items-title">
          <h2>Backlog Items</h2>
          <p class="items-subtitle">Manage items for this product backlog</p>
        </div>
        <div class="items-actions">
          <button
            pButton
            type="button"
            label="Add Item"
            icon="pi pi-plus"
            class="p-button-primary"
            (click)="showAddItemDialog()">
          </button>
        </div>
      </div>
      <!-- Items Stats Cards -->
      <div class="items-stats-grid">
        <div class="stat-card">
          <div class="stat-content">
            <div class="stat-number">{{ getTotalItemsCount() }}</div>
            <div class="stat-label">Total Items</div>
          </div>
          <div class="stat-icon">
            <i class="pi pi-list"></i>
          </div>
        </div>
        <div class="stat-card todo">
          <div class="stat-content">
            <div class="stat-number">{{ getTodoItems() }}</div>
            <div class="stat-label">To Do</div>
          </div>
          <div class="stat-icon">
            <i class="pi pi-circle"></i>
          </div>
        </div>
        <div class="stat-card progress">
          <div class="stat-content">
            <div class="stat-number">{{ getInProgressItems() }}</div>
            <div class="stat-label">In Progress</div>
          </div>
          <div class="stat-icon">
            <i class="pi pi-clock"></i>
          </div>
        </div>
        <div class="stat-card completed">
          <div class="stat-content">
            <div class="stat-number">{{ getCompletedItems() }}</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-icon">
            <i class="pi pi-check-circle"></i>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-content">
            <div class="stat-number">{{ getTotalStoryPoints() }}</div>
            <div class="stat-label">Story Points</div>
          </div>
          <div class="stat-icon">
            <i class="pi pi-star"></i>
          </div>
        </div>
      </div>
      <!-- Items Table -->
      <div class="backlog-items-table-container">
        <p-table
          [value]="backlogItems"
          [(selection)]="selectedItems"
          [paginator]="true"
          [rows]="itemPageSize"
          [totalRecords]="totalItemRecords"
          [lazy]="true"
          (onLazyLoad)="onItemPageChange($event)"
          [loading]="itemsLoading"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
          [rowsPerPageOptions]="[10, 25, 50]"
          styleClass="p-datatable-gridlines"
          responsiveLayout="scroll">
          <ng-template pTemplate="caption">
            <div class="table-header">
              <span class="table-title">Backlog Items</span>
              <div class="table-actions">
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-danger p-button-outlined"
                  [disabled]="selectedItems.length === 0"
                  (click)="bulkDeleteItems()"
                  pTooltip="Delete Selected">
                </button>
              </div>
            </div>
          </ng-template>
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 3rem">
                <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
              </th>
              <th pSortableColumn="titre">Title <p-sortIcon field="titre"></p-sortIcon></th>
              <th pSortableColumn="priorite">Priority <p-sortIcon field="priorite"></p-sortIcon></th>
              <th pSortableColumn="points">Points <p-sortIcon field="points"></p-sortIcon></th>
              <th pSortableColumn="statut">Status <p-sortIcon field="statut"></p-sortIcon></th>
              <th style="width: 12rem">Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>
                <p-tableCheckbox [value]="item"></p-tableCheckbox>
              </td>
              <td>
                <div class="item-title">
                  <strong>{{ item.titre }}</strong>
                  @if (item.description) {
                    <div class="item-description">
                      {{ item.description }}
                    </div>
                  }
                </div>
              </td>
              <td>
                <p-dropdown
                  [ngModel]="item.priorite"
                  [options]="priorityOptions"
                  optionLabel="label"
                  optionValue="value"
                  (onChange)="updatePriority(item, $event.value)"
                  [style]="{'min-width': '120px'}">
                </p-dropdown>
              </td>
              <td>
                @if (item.points) {
                  <span class="story-points">{{ item.points }}</span>
                }
                @if (!item.points) {
                  <span>-</span>
                }
              </td>
              <td>
                <p-dropdown
                  [ngModel]="item.statut"
                  [options]="statusOptions"
                  optionLabel="label"
                  optionValue="value"
                  (onChange)="changeStatus(item, $event.value)"
                  [style]="{'min-width': '120px'}">
                </p-dropdown>
              </td>
              <td>
                <div class="action-buttons">
                  <button
                    pButton
                    type="button"
                    icon="pi pi-pencil"
                    class="p-button-text p-button-sm"
                    (click)="editItem(item)"
                    pTooltip="Edit">
                  </button>
                  <button
                    pButton
                    type="button"
                    icon="pi pi-trash"
                    class="p-button-text p-button-sm p-button-danger"
                    (click)="deleteItem(item)"
                    pTooltip="Delete">
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="text-center">
                <div class="empty-state">
                  <i class="pi pi-inbox empty-icon"></i>
                  <h3>No backlog items found</h3>
                  <p>Start by creating your first backlog item</p>
                  <button
                    pButton
                    type="button"
                    label="Create First Item"
                    icon="pi pi-plus"
                    class="p-button-primary"
                    (click)="showAddItemDialog()">
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  }
</div>

<!-- Add/Edit Backlog Dialog -->
<p-dialog
  [(visible)]="displayDialog"
  [header]="isEditMode ? 'Edit Product Backlog' : 'Create Product Backlog'"
  [modal]="true"
  [style]="{width: '500px'}"
  [closable]="true"
  [draggable]="false"
  [resizable]="false">

  <div class="dialog-content">
    <div class="field">
      <label for="project">Project *</label>
      <p-dropdown
        id="project"
        [(ngModel)]="currentBacklog.projetId"
        [options]="projects"
        optionLabel="nom"
        optionValue="id"
        placeholder="Select a project"
        class="w-full"
        [disabled]="singleProjectMode">
      </p-dropdown>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button
        pButton
        type="button"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-text"
        (click)="displayDialog = false">
      </button>
      <button
        pButton
        type="button"
        [label]="isEditMode ? 'Update' : 'Create'"
        icon="pi pi-check"
        class="p-button-primary"
        [disabled]="!isFormValid()"
        (click)="saveBacklog()">
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Added Add/Edit Item Dialog -->
<p-dialog
  [(visible)]="displayItemDialog"
  [header]="isEditItemMode ? 'Edit Backlog Item' : 'Create Backlog Item'"
  [modal]="true"
  [style]="{width: '600px'}"
  [closable]="true"
  [draggable]="false"
  [resizable]="false">

  <div class="dialog-content">
    <div class="field">
      <label for="titre">Title *</label>
      <input
        id="titre"
        type="text"
        pInputText
        [(ngModel)]="currentItem.titre"
        placeholder="Enter item title"
        class="w-full">
      </div>

      <div class="field">
        <label for="description">Description</label>
        <textarea
          id="description"
          pInputTextarea
          [(ngModel)]="currentItem.description"
          placeholder="Enter item description"
          rows="3"
          class="w-full">
        </textarea>
      </div>

      <div class="field-group">
        <div class="field">
          <label for="priorite">Priority *</label>
          <p-dropdown
            id="priorite"
            [(ngModel)]="currentItem.priorite"
            [options]="priorityOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="Select priority"
            class="w-full">
          </p-dropdown>
        </div>

        <div class="field">
          <label for="points">Story Points</label>
          <p-inputNumber
            id="points"
            [(ngModel)]="currentItem.points"
            [min]="0"
            [max]="100"
            placeholder="0"
            class="w-full">
          </p-inputNumber>
        </div>
      </div>

      <div class="field">
        <label for="statut">Status</label>
        <p-dropdown
          id="statut"
          [(ngModel)]="currentItem.statut"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select status"
          class="w-full">
        </p-dropdown>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <button
          pButton
          type="button"
          label="Cancel"
          icon="pi pi-times"
          class="p-button-text"
          (click)="displayItemDialog = false">
        </button>
        <button
          pButton
          type="button"
          [label]="isEditItemMode ? 'Update' : 'Create'"
          icon="pi pi-check"
          class="p-button-primary"
          [disabled]="!isItemFormValid()"
          (click)="saveItem()">
        </button>
      </div>
    </ng-template>
  </p-dialog>

  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>
