<div class="layout-wrapper">
  <app-topbar></app-topbar>
  <app-sidebar></app-sidebar>

  <div class="layout-main-container">
    <div class="layout-main">
      <div class="card">
        <!-- Header -->
        <div class="flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="text-2xl font-bold text-900 m-0">User Stories</h2>
            <p class="text-600 mt-1 mb-0">Gérer les user stories du projet</p>
          </div>
          <div class="flex gap-2">
            <p-button
              icon="pi pi-arrow-left"
              label="Retour"
              severity="secondary"
              (onClick)="goBack()">
            </p-button>
            <p-button
              icon="pi pi-plus"
              label="Ajouter User Story"
              (onClick)="showAddDialog()">
            </p-button>
          </div>
        </div>

        <!-- Statistics Cards -->
        <div class="flex gap-4 mb-4">
          <div class="flex-1 min-w-0">
            <div class="card bg-white border-1 border-gray-200 shadow-1">
              <div class="flex justify-content-between align-items-center">
                <div>
                  <div class="text-3xl font-bold text-900 mb-1">{{ getTotalUserStories() }}</div>
                  <div class="text-600 font-medium">Total Stories</div>
                </div>
                <i class="pi pi-list text-2xl text-teal-500"></i>
              </div>
            </div>
          </div>

          <div class="flex-1 min-w-0">
            <div class="card bg-white border-1 border-gray-200 shadow-1">
              <div class="flex justify-content-between align-items-center">
                <div>
                  <div class="text-3xl font-bold text-900 mb-1">{{ getUserStoriesByStatus('A_FAIRE') }}</div>
                  <div class="text-600 font-medium">À faire</div>
                </div>
                <i class="pi pi-clock text-2xl text-blue-500"></i>
              </div>
            </div>
          </div>

          <div class="flex-1 min-w-0">
            <div class="card bg-white border-1 border-gray-200 shadow-1">
              <div class="flex justify-content-between align-items-center">
                <div>
                  <div class="text-3xl font-bold text-900 mb-1">{{ getUserStoriesByStatus('EN_COURS') }}</div>
                  <div class="text-600 font-medium">En cours</div>
                </div>
                <i class="pi pi-refresh text-2xl text-orange-500"></i>
              </div>
            </div>
          </div>

          <div class="flex-1 min-w-0">
            <div class="card bg-white border-1 border-gray-200 shadow-1">
              <div class="flex justify-content-between align-items-center">
                <div>
                  <div class="text-3xl font-bold text-900 mb-1">{{ getUserStoriesByStatus('TERMINE') }}</div>
                  <div class="text-600 font-medium">Terminées</div>
                </div>
                <i class="pi pi-check-circle text-2xl text-green-500"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Compact search area in one horizontal line -->
        <div class="flex align-items-center gap-3 mb-4 p-3 bg-gray-50 border-1 border-gray-200 border-round">
          <div class="flex-1">
            <p-iconfield iconPosition="left">
              <input
                pInputText
                type="text"
                placeholder="Rechercher titre ou description..."
                [(ngModel)]="searchTerm"
                (input)="onSearchChange()"
                class="w-full"
                />
                <p-inputicon class="pi pi-search"></p-inputicon>
              </p-iconfield>
            </div>

            <div class="flex-none" style="min-width: 150px;">
              <p-dropdown
                [(ngModel)]="statusFilter"
                [options]="statusFilterOptions"
                (onChange)="onStatusChange()"
                placeholder="Statut"
                class="w-full"
              ></p-dropdown>
            </div>

            <div class="flex-none" style="min-width: 150px;">
              <p-dropdown
                [(ngModel)]="priorityFilter"
                [options]="priorityFilterOptions"
                (onChange)="onPriorityChange()"
                placeholder="Priorité"
                class="w-full"
              ></p-dropdown>
            </div>

            <div class="flex-none">
              <p-button
                icon="pi pi-refresh"
                severity="secondary"
                [text]="true"
                pTooltip="Réinitialiser les filtres"
                (onClick)="clearFilters()"
                [disabled]="!hasActiveFilters()"
              ></p-button>
            </div>
          </div>

          <!-- Results Info -->
          @if (!loading) {
            <div class="mb-3">
              <p class="text-600 text-sm m-0">
                Affichage de {{filteredUserStories.length}} sur {{allUserStories.length}} user stories
                @if (searchTerm) {
                  <span class="font-semibold text-primary">pour "{{searchTerm}}"</span>
                }
              </p>
            </div>
          }

          <!-- Updated table to use filteredUserStories and removed pagination -->
          <p-table
            [value]="filteredUserStories"
            [loading]="loading"
            styleClass="p-datatable-gridlines">

            <ng-template pTemplate="header">
              <tr>
                <th>Titre</th>
                <th>Description</th>
                <th>Priorité</th>
                <th>Statut</th>
                <th>Story Points</th>
                <th>Sprint</th>
                <th>Tâches</th>
                <th>Actions</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-story>
              <tr>
                <td>
                  <div class="font-medium text-900 mb-1">{{ story.titre }}</div>
                </td>
                <td>
                  <div class="text-sm text-600 max-w-15rem">{{ story.description }}</div>
                </td>
                <td>
                  <p-tag
                    [value]="getPriorityLabel(story.priorite || 2)"
                    [severity]="getPrioritySeverity(story.priorite || 2)">
                  </p-tag>
                </td>
                <td>
                  <p-dropdown
                    [ngModel]="story.statut"
                    [options]="statusOptions"
                    (onChange)="changeStatus(story, $event.value)"
                    placeholder="Changer statut">
                    <ng-template pTemplate="selectedItem">
                      <p-tag
                        [value]="getStatusLabel(story.statut || 'A_FAIRE')"
                        [severity]="getStatusSeverity(story.statut || 'A_FAIRE')">
                      </p-tag>
                    </ng-template>
                    <ng-template pTemplate="item" let-option>
                      <span>{{ option.label }}</span>
                    </ng-template>
                  </p-dropdown>
                </td>
                <td>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600">{{ story.points }}</div>
                    <div class="text-xs text-600">points</div>
                  </div>
                </td>
                <td>
                  <div class="text-sm">{{ story.sprintBacklogNom || 'Aucun sprint' }}</div>
                </td>
                <td>
                  <div class="text-center">
                    <div class="font-medium">{{ story.nombreTachesTerminees || 0 }}/{{ story.nombreTaches || 0 }}</div>
                    <div class="text-xs text-600">terminées</div>
                    <div class="text-xs text-600">{{ story.pourcentageCompletion || 0 }}%</div>
                  </div>
                </td>
                <td>
                  <div class="flex gap-1">
                    <p-button
                      icon="pi pi-pencil"
                      size="small"
                      severity="success"
                      [text]="true"
                      pTooltip="Modifier"
                      (onClick)="editUserStory(story)">
                    </p-button>
                    <p-button
                      icon="pi pi-trash"
                      size="small"
                      severity="danger"
                      [text]="true"
                      pTooltip="Supprimer"
                      (onClick)="deleteUserStory(story)">
                    </p-button>
                  </div>
                </td>
              </tr>
            </ng-template>

            <!-- Empty State -->
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="8" class="text-center py-6">
                  @if (hasActiveFilters()) {
                    <div>
                      <i class="pi pi-search text-4xl text-gray-400 mb-3"></i>
                      <p class="text-gray-600 mb-3">Aucune user story ne correspond à vos critères de recherche.</p>
                      <p-button
                        label="Effacer les filtres"
                        class="p-button-outlined"
                        (onClick)="clearFilters()">
                      </p-button>
                    </div>
                  } @else {
                    <i class="pi pi-list text-4xl text-gray-400 mb-3"></i>
                    <p class="text-gray-600">Aucune user story disponible.</p>
                  }
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit User Story Dialog -->
  <p-dialog
    [(visible)]="displayDialog"
    [header]="isEditMode ? 'Modifier User Story' : 'Ajouter User Story'"
    [modal]="true"
    [style]="{width: '600px'}"
    [closable]="true">

    <div class="grid formgrid p-fluid">
      <div class="field col-12">
        <label for="titre" class="font-medium">Titre *</label>
        <input
          pInputText
          id="titre"
          [(ngModel)]="userStoryForm.titre"
          placeholder="Entrer le titre de la user story"
          class="w-full">
        </div>

        <div class="field col-12">
          <label for="description" class="font-medium">Description *</label>
          <textarea
            pInputTextarea
            id="description"
            [(ngModel)]="userStoryForm.description"
            placeholder="Décrire la user story"
            rows="3"
            class="w-full">
          </textarea>
        </div>

        <div class="field col-4">
          <label for="priorite" class="font-medium">Priorité</label>
          <p-dropdown
            [(ngModel)]="userStoryForm.priorite"
            [options]="priorityOptions"
            placeholder="Sélectionner priorité"
            inputId="priorite">
          </p-dropdown>
        </div>

        <div class="field col-4">
          <label for="statut" class="font-medium">Statut</label>
          <p-dropdown
            [(ngModel)]="userStoryForm.statut"
            [options]="statusOptions"
            placeholder="Sélectionner statut"
            inputId="statut">
          </p-dropdown>
        </div>

        <div class="field col-4">
          <label for="points" class="font-medium">Story Points</label>
          <p-dropdown
            [(ngModel)]="userStoryForm.points"
            [options]="storyPointOptions"
            placeholder="Sélectionner points"
            inputId="points">
          </p-dropdown>
        </div>
      </div>

      <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2">
          <p-button
            label="Annuler"
            severity="secondary"
            (onClick)="displayDialog = false">
          </p-button>
          <p-button
            [label]="isEditMode ? 'Mettre à jour' : 'Créer'"
            [loading]="loading"
            (onClick)="saveUserStory()">
          </p-button>
        </div>
      </ng-template>
    </p-dialog>

    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>
