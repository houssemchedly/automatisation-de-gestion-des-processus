<div class="card">

  <div class="flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="text-2xl font-bold text-900 m-0">User Management</h2>
      <p class="text-600 mt-1 mb-0">Manage system users, roles, and permissions</p>
    </div>
    <div class="flex gap-2">
      <p-button
        icon="pi pi-arrow-left"
        label="Back"
        severity="secondary"
        (onClick)="goBack()">
      </p-button>
      <p-button
        icon="pi pi-download"
        label="Export"
        severity="help"
        (onClick)="exportUsers()">
      </p-button>
      <p-button
        icon="pi pi-plus"
        label="Add User"
        [disabled]="loading"
        (onClick)="showAddDialog()">
      </p-button>
    </div>
  </div>

  @if (errorMessage) {
    <div class="mb-4">
      <p-message
        severity="error"
        [text]="errorMessage"
        [closable]="true"
        (onClose)="clearError()">
      </p-message>
    </div>
  }

  @if (loading) {
    <div class="flex justify-content-center align-items-center p-4">
      <p-progressSpinner
        [style]="{'width': '50px', 'height': '50px'}"
        strokeWidth="4"
        animationDuration="1s">
      </p-progressSpinner>
      <span class="ml-3 text-600">Loading users...</span>
    </div>
  }

  @if (!loading) {
    <div class="flex flex-wrap gap-3 mb-4 align-items-end">
      <div class="flex-1 min-w-0">
        <label for="searchTerm" class="block text-sm font-medium text-700 mb-1">Search Users</label>
        <span class="p-input-icon-left w-full">
          <i class="pi pi-search"></i>
          <input
            pInputText
            id="searchTerm"
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            placeholder="Search by name or email..."
            class="w-full">
          </span>
        </div>
        <div class="flex-none">
          <label for="statusFilter" class="block text-sm font-medium text-700 mb-1">Filter by Status</label>
          <p-dropdown
            [(ngModel)]="selectedStatusFilter"
            (ngModelChange)="onStatusFilterChange()"
            [options]="statusFilterOptions"
            placeholder="All Users"
            inputId="statusFilter"
            [style]="{'min-width': '150px'}">
          </p-dropdown>
        </div>
        <div class="flex-none">
          <label class="block text-sm font-medium text-700 mb-1">Active Only</label>
          <p-inputSwitch
            [(ngModel)]="showActiveOnly"
            (ngModelChange)="onActiveFilterChange()">
          </p-inputSwitch>
        </div>
        <div class="flex-none">
          <p-button
            icon="pi pi-filter-slash"
            label="Clear Filters"
            severity="secondary"
            [text]="true"
            (onClick)="clearFilters()">
          </p-button>
        </div>
      </div>
    }

    Statistics Cards
    @if (!loading) {
      <div class="flex flex-wrap gap-3 mb-4">
        <div class="flex-1 min-w-0">
          <div class="card bg-white border-1 border-200 shadow-1 p-3">
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <div class="text-3xl font-bold text-900 mb-1">{{ getTotalUsers() }}</div>
                <div class="text-600 font-medium">Total Users</div>
              </div>
              <i class="pi pi-users text-teal-500 text-2xl"></i>
            </div>
          </div>
        </div>
        <div class="flex-1 min-w-0">
          <div class="card bg-white border-1 border-200 shadow-1 p-3">
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <div class="text-600 font-medium mb-1">Active</div>
                <div class="text-2xl font-bold text-900">{{ getActiveUsers() }}</div>
              </div>
              <i class="pi pi-check-circle text-green-400 text-2xl"></i>
            </div>
          </div>
        </div>
        <div class="flex-1 min-w-0">
          <div class="card bg-white border-1 border-200 shadow-1 p-3">
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <div class="text-600 font-medium mb-1">Locked</div>
                <div class="text-2xl font-bold text-900">{{ getLockedUsers() }}</div>
              </div>
              <i class="pi pi-lock text-red-400 text-2xl"></i>
            </div>
          </div>
        </div>
        <div class="flex-1 min-w-0">
          <div class="card bg-white border-1 border-200 shadow-1 p-3">
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <div class="text-600 font-medium mb-1">Admins</div>
                <div class="text-2xl font-bold text-900">{{ getAdminUsers() }}</div>
              </div>
              <i class="pi pi-shield text-blue-400 text-2xl"></i>
            </div>
          </div>
        </div>
      </div>
    }

    Bulk Actions
    @if (!loading) {
      <div class="flex justify-content-between align-items-center mb-3">
        <div class="flex gap-2">
          <p-button
            icon="pi pi-trash"
            label="Delete Selected"
            severity="danger"
            [disabled]="selectedUsers.length === 0 || loading"
            (onClick)="deleteSelectedUsers()">
          </p-button>
        </div>
      </div>
    }

    Users Table
    <p-table
      [value]="users"
      [paginator]="true"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} users"
      [rowsPerPageOptions]="[10, 25, 50]"
      [(selection)]="selectedUsers"
      [selectAll]="false"
      styleClass="p-datatable-gridlines"
      [loading]="loading"
      (onPage)="onPageChange($event)">

      <ng-template pTemplate="header">
        <tr>
          <th>
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th>User</th>
          <th>Email</th>
          <th>Status</th>
          <th>Account</th>
          <th>Roles</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-user>
        <tr>
          <td>
            <p-tableCheckbox [value]="user"></p-tableCheckbox>
          </td>
          <td>
            <div class="flex align-items-center gap-3">
              <div class="flex align-items-center justify-content-center bg-primary-100 text-primary-700 border-circle w-3rem h-3rem">
                <span class="font-bold">{{ user.prenom?.charAt(0) }}{{ user.nom?.charAt(0) }}</span>
              </div>
              <div>
                <div class="font-medium text-900">{{ user.prenom }} {{ user.nom }}</div>
                <div class="text-sm text-600">ID: {{ user.id }}</div>
              </div>
            </div>
          </td>
          <td>
            <div class="text-sm">
              <div class="font-medium">{{ user.email }}</div>
              @if (user.dateNaissance) {
                <div class="text-600">
                  Born: {{ formatDate(user.dateNaissance) }}
                </div>
              }
            </div>
          </td>
          <td>
            <p-tag
              [value]="user.enabled ? 'Active' : 'Inactive'"
              [severity]="getStatusSeverity(user.enabled)">
            </p-tag>
            <div class="mt-1">
              <p-button
                [icon]="user.enabled ? 'pi pi-eye-slash' : 'pi pi-eye'"
                [label]="user.enabled ? 'Deactivate' : 'Activate'"
                size="small"
                [severity]="user.enabled ? 'secondary' : 'success'"
                [text]="true"
                [disabled]="loading"
                (onClick)="toggleUserStatus(user)">
              </p-button>
            </div>
          </td>
          <td>
            <p-tag
              [value]="user.accountLocked ? 'Locked' : 'Unlocked'"
              [severity]="getLockSeverity(user.accountLocked)">
            </p-tag>
            <div class="mt-1">
              <p-button
                [icon]="user.accountLocked ? 'pi pi-unlock' : 'pi pi-lock'"
                [label]="user.accountLocked ? 'Unlock' : 'Lock'"
                size="small"
                [severity]="user.accountLocked ? 'success' : 'danger'"
                [text]="true"
                [disabled]="loading"
                (onClick)="toggleUserLock(user)">
              </p-button>
            </div>
          </td>
          <td>
            @if (user.roles && user.roles.length > 0) {
              <div class="flex flex-wrap gap-1">
                @for (role of user.roles; track role) {
                  <p-tag
                    [value]="role.name"
                    severity="info"
                    class="text-xs">
                  </p-tag>
                }
              </div>
            }
            @if (!user.roles || user.roles.length === 0) {
              <span class="text-sm text-600">No roles</span>
            }
          </td>
          <td>
            <div class="text-sm text-600">{{ formatDate(user.createdDate) }}</div>
          </td>
          <td>
            <div class="flex gap-1">
              <p-button
                icon="pi pi-pencil"
                size="small"
                severity="success"
                [text]="true"
                [disabled]="loading"
                pTooltip="Edit User"
                (onClick)="editUser(user)">
              </p-button>
              <p-button
                icon="pi pi-trash"
                size="small"
                severity="danger"
                [text]="true"
                [disabled]="loading"
                pTooltip="Delete User"
                (onClick)="deleteUser(user)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  Add/Edit User Dialog
  <p-dialog
    [(visible)]="displayDialog"
    [header]="isEditMode ? 'Edit User' : 'Add New User'"
    [modal]="true"
    [style]="{width: '500px'}"
    [closable]="true">

    <div class="grid formgrid p-fluid">
      <div class="field col-6">
        <label for="prenom" class="font-medium">First Name *</label>
        <input
          pInputText
          id="prenom"
          [(ngModel)]="user.prenom"
          placeholder="Enter first name"
          class="w-full">
        </div>

        <div class="field col-6">
          <label for="nom" class="font-medium">Last Name *</label>
          <input
            pInputText
            id="nom"
            [(ngModel)]="user.nom"
            placeholder="Enter last name"
            class="w-full">
          </div>

          <div class="field col-12">
            <label for="email" class="font-medium">Email *</label>
            <input
              pInputText
              id="email"
              [(ngModel)]="user.email"
              placeholder="Enter email address"
              type="email"
              class="w-full">
            </div>

            @if (availableRoles.length > 0) {
              <div class="field col-12">
                <label for="roles" class="font-medium">Roles</label>
                <p-multiSelect
                  [(ngModel)]="user.roleIds"
                  [options]="availableRoles"
                  optionLabel="name"
                  optionValue="id"
                  placeholder="Select roles"
                  inputId="roles"
                  [scrollHeight]="'200px'"
                  [style]="{'width': '100%'}"
                  [panelStyle]="{'max-height': '200px', 'overflow-y': 'auto', 'z-index': '9999'}"
                  [appendTo]="'body'"
                  [showToggleAll]="false"
                  [filter]="true"
                  filterPlaceholder="Search roles..."
                  class="w-full">
                </p-multiSelect>
              </div>
            }

            <div class="field col-6">
              <div class="flex align-items-center gap-2">
                <input
                  type="checkbox"
                  id="enabled"
                  [(ngModel)]="user.enabled"
                  class="mr-2">
                  <label for="enabled" class="font-medium">Account Enabled</label>
                </div>
              </div>

              <div class="field col-6">
                <div class="flex align-items-center gap-2">
                  <input
                    type="checkbox"
                    id="accountLocked"
                    [(ngModel)]="user.accountLocked"
                    class="mr-2">
                    <label for="accountLocked" class="font-medium">Account Locked</label>
                  </div>
                </div>
              </div>

              <ng-template pTemplate="footer">
                <div class="flex justify-content-end gap-2">
                  <p-button
                    label="Cancel"
                    severity="secondary"
                    [disabled]="loading"
                    (onClick)="displayDialog = false">
                  </p-button>
                  <p-button
                    [label]="isEditMode ? 'Update' : 'Create'"
                    [loading]="loading"
                    (onClick)="saveUser()">
                  </p-button>
                </div>
              </ng-template>
            </p-dialog>

            <p-confirmDialog
              [style]="{width: '450px'}"
              [baseZIndex]="10000"
              rejectButtonStyleClass="p-button-text">
            </p-confirmDialog>

            <p-toast position="top-right"></p-toast>
